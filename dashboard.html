<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Teste da API</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1e21; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; }
        h1, h2 { color: #1877f2; }
        h1 { text-align: center; }
        #login-section, .resource-section { background-color: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input[type="text"], input[type="password"], input[type="number"], input[type="date"], select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #dddfe2; box-sizing: border-box; }
        button { font-size: 14px; font-weight: bold; padding: 10px 15px; border: none; background-color: #1877f2; color: white; border-radius: 6px; cursor: pointer; margin-right: 5px; margin-top: 5px; }
        button:hover { background-color: #166fe5; }
        .btn-get { background-color: #42b72a; }
        .btn-get:hover { background-color: #36a420; }
        .btn-update { background-color: #f0ad4e; }
        .btn-update:hover { background-color: #ec9b2e; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #c82333; }
        #logoutButton { background-color: #6c757d; }
        #logoutButton:hover { background-color: #5a6268; }
        pre { background-color: #f0f2f5; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #dddfe2; }
        form { margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #606770; }
        .id-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .id-form input { flex-grow: 1; }
        .checkbox-group { border: 1px solid #dddfe2; padding: 10px; border-radius: 6px; max-height: 150px; overflow-y: auto; }
        .checkbox-group label { display: block; font-weight: normal; }
        .checkbox-group label:hover { background-color: #f0f2f5; }

    </style>
</head>
<body>

<div class="container">
    <div id="login-section">
        <h1>Login no Dashboard da API</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Usuário:</label>
                <input type="text" id="username" name="username" value="admin" required>
            </div>
            <div class="form-group">
                <label for="senha">Senha:</label>
                <input type="password" id="senha" name="senha" value="senha123" required>
            </div>
            <button type="submit">Login</button>
        </form>
    </div>

    <div id="dashboard-section" style="display: none;">
        <h1>Dashboard de Teste da API</h1>
        <p>Logado como: <b id="loggedInUser"></b> <button id="logoutButton">Logout</button></p>
        <hr>

        <div id="crud-container"></div>

        <hr>
        <h3>Payload da Requisição:</h3>
        <pre id="request-payload">Nenhuma requisição enviada.</pre>

        <hr>
        <h3>Resposta do Servidor:</h3>
        <pre id="response">Aguardando uma operação...</pre>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:3000';
    let apiToken = null;

    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const loginForm = document.getElementById('loginForm');
    const logoutButton = document.getElementById('logoutButton');
    const responseEl = document.getElementById('response');
    const crudContainer = document.getElementById('crud-container');
    const loggedInUserEl = document.getElementById('loggedInUser');
    const requestPayloadEl = document.getElementById('request-payload');

    function displayResponse(data) {
        responseEl.textContent = JSON.stringify(data, null, 2);
    }

   function displayRequest(method, endpoint, body) {
        const payload = {
            method,
            endpoint: `${API_BASE_URL}${endpoint}`,
            body: body || null
        };
        requestPayloadEl.textContent = JSON.stringify(payload, null, 2);
        // Limpa a resposta anterior para evitar confusão
        responseEl.textContent = 'Aguardando resposta do servidor...';
    }

    function generateCrudHtml(resource, resourceKey) {
        const { name, path, fields = [], isReadOnly, isCreateOnly, filters = [] } = resource;
        const id = resourceKey; // Usar a chave do objeto como ID único

        const createFormFields = fields.map(f => `
            ${(() => {
                if (f.type === 'checkbox-group') {
                    return `
                        <div class="form-group">
                            <label>${f.label}:</label>
                            <div class="checkbox-group" data-name="${f.name}" data-source="${f.dataSource}">
                                Carregando opções...
                            </div>
                        </div>
                    `;
                }
                if (f.type === 'select') {
                    return `
                        <div class="form-group">
                            <label for="create-${id}-${f.name}">${f.label}:</label>
                            <select id="create-${id}-${f.name}" name="${f.name}" data-source="${f.dataSource}" ${f.required ? 'required' : ''}>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                    `;
                }
                return `
                    <div class="form-group">
                        <label for="create-${id}-${f.name}">${f.label}:</label>
                        <input type="${f.type || 'text'}" id="create-${id}-${f.name}" name="${f.name}" placeholder="${f.placeholder || ''}" ${f.required ? 'required' : ''}>
                    </div>
                `;
            })()}
        `).join('');

        const filterFormFields = filters.map(f => `
            <div class="form-group">
                <label for="filter-${id}-${f.name}">${f.label}:</label>
                <select id="filter-${id}-${f.name}" name="${f.name}" data-source="${f.dataSource}">
                    <option value="">-- Todos --</option>
                </select>
            </div>
        `).join('');

        const filterForm = filters.length > 0 ? `
            <form data-resource="${id}" data-action="filter">
                <h3>Filtrar ${name}</h3>
                ${filterFormFields}
                <button type="submit">Filtrar</button>
            </form>
        ` : '';

        return `
            <div class="resource-section">
                <h2>${name} (<code>${path}</code>)</h2>
                ${!isCreateOnly ? `<button class="btn-get" data-resource="${id}" data-action="getAll">Listar Todos</button>` : ''}
                
                ${!isCreateOnly ? `
                <form class="id-form" data-resource="${id}" data-action="getById">
                    <input type="text" placeholder="ID para buscar, atualizar ou deletar" required>
                    <button type="submit" class="btn-get">Buscar por ID</button>
                    ${!isReadOnly ? `
                    <button type="button" class="btn-update" data-resource="${id}" data-action="update">Atualizar</button>
                    <button type="button" class="btn-delete" data-resource="${id}" data-action="delete">Deletar</button>
                    ` : ''}
                </form>
                ` : ''}

                ${!isReadOnly ? `
                <form data-resource="${id}" data-action="create">
                    <h3>Criar Novo(a) ${name}</h3>
                    ${createFormFields}
                    <button type="submit">Criar</button>
                </form>
                ` : ''}

                ${filterForm}
            </div>
        `;
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
        const headers = { 'Content-Type': 'application/json' };
        if (apiToken) {
            headers['Authorization'] = `Bearer ${apiToken}`;
        }

        const config = { method, headers };
        if (body) {
            config.body = JSON.stringify(body);
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            if (response.status === 204) {
                return { status: 204, message: 'Operação bem-sucedida (No Content).' };
            }
            const data = await response.json();
            if (!response.ok) throw data;
            return data;
        } catch (error) {
            console.error('Erro na chamada da API:', error);
            return { error: error.message || error.error || 'Ocorreu um erro desconhecido.' };
        }
    }

    const resources = {
        cidades: { name: 'Cidades', path: '/cidades', fields: [{ name: 'nome', label: 'Nome', required: true }, { name: 'estado', label: 'Estado (UF)', required: true, placeholder: 'Ex: BA' }] },
        escolas: { name: 'Escolas', path: '/escolas', fields: [{ name: 'nome', label: 'Nome', required: true }, { name: 'id_cidade', label: 'ID da Cidade', required: true, placeholder: 'UUID da cidade' }] },
        salas: { name: 'Salas', path: '/salas', fields: [{ name: 'nome', label: 'Nome', required: true, placeholder: 'Ex: 6ºA' }, { name: 'id_escola', label: 'ID da Escola', required: true, placeholder: 'UUID da escola' }] },
        jogos: { name: 'Jogos', path: '/jogos', fields: [
            { name: 'nome', label: 'Nome', required: true }, { name: 'descricao', label: 'Descrição' },
            { name: 'url_jogo', label: 'URL do Jogo' }, { name: 'url_thumbnail', label: 'URL da Thumbnail' },
            { name: 'disciplinaIds', label: 'Disciplinas', type: 'checkbox-group', dataSource: '/disciplinas' },
            { name: 'anoIds', label: 'Anos', type: 'checkbox-group', dataSource: '/anos' }
        ], filters: [
            { name: 'disciplinaId', label: 'Filtrar por Disciplina', type: 'select', dataSource: '/disciplinas' },
            { name: 'anoId', label: 'Filtrar por Ano', type: 'select', dataSource: '/anos' }
        ]},
        disciplinas: { name: 'Disciplinas', path: '/disciplinas', fields: [{ name: 'nome', label: 'Nome', required: true }] },
        anos: { name: 'Anos', path: '/anos', fields: [{ name: 'nome', label: 'Nome', required: true }] },
        conquistas: { name: 'Conquistas', path: '/conquistas', fields: [{ name: 'nome', label: 'Nome', required: true }, { name: 'descricao', label: 'Descrição' }, { name: 'icone_url', label: 'URL do Ícone' }] },
        usuarios: { name: 'Usuários', path: '/usuarios', fields: [
            { name: 'nome', label: 'Nome Completo', required: true }, { name: 'username', label: 'Username', required: true },
            { name: 'senha', label: 'Senha', type: 'password', required: true }, { name: 'id_papel', label: 'ID do Papel', required: true, placeholder: 'UUID do papel' }, // TODO: Mudar para select
            { name: 'id_escola', label: 'Escola', type: 'select', dataSource: '/escolas', required: true }, 
            { name: 'id_sala', label: 'Sala (opcional)', type: 'select', dataSource: '/salas' },
            { name: 'matricula', label: 'Matrícula (opcional)' }, { name: 'ano', label: 'Ano (opcional)' },
        ]},
        atividades: { name: 'Atividades (atribuir jogo)', path: '/atividades', isReadOnly: true, fields: [
            { name: 'id_jogo', label: 'Jogo', type: 'select', dataSource: '/jogos', required: true },
            { name: 'id_sala', label: 'Sala', type: 'select', dataSource: '/salas/minha-escola', required: true },
            { name: 'data_fim', label: 'Data de Fim (opcional)', type: 'date' }
        ]},
        pontuacoes: { name: 'Pontuações', path: '/pontuacoes', fields: [{ name: 'id_usuario', label: 'ID do Usuário', required: true }, { name: 'id_jogo', label: 'ID do Jogo', required: true, placeholder: 'UUID do jogo' }, { name: 'pontuacao', label: 'Pontuação', type: 'number', required: true }] },
        'usuarios-conquistas': { name: 'Atribuir Conquista', path: '/usuarios-conquistas', isCreateOnly: true, fields: [{ name: 'id_usuario', label: 'ID do Usuário', required: true }, { name: 'id_conquista', label: 'ID da Conquista', required: true }] }
    };

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        displayResponse({ message: 'Autenticando...' });
        const data = await apiCall('/auth/login', 'POST', { username: e.target.username.value, senha: e.target.senha.value });
        displayResponse(data);
        if (data && data.token) {
            apiToken = data.token;
            loginSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            loggedInUserEl.textContent = data.user.username;
            populateAllDynamicFields(); // Popula os campos dinâmicos após o login
        }
    });

    logoutButton.addEventListener('click', () => {
        apiToken = null;
        loginSection.style.display = 'block';
        dashboardSection.style.display = 'none';
        responseEl.textContent = 'Você foi deslogado.';
    });

    crudContainer.addEventListener('click', async (e) => {
        try {
            const button = e.target;
            if (button.tagName !== 'BUTTON') return;

            const action = button.dataset.action;
            if (!action) return;

            // Apenas previne o padrão para botões que gerenciamos aqui (com data-action)
            e.preventDefault();

            const resourceId = button.dataset.resource;
            const resource = resources[resourceId];
            
            if (action === 'getAll') {
                displayRequest('GET', resource.path, null);
                const result = await apiCall(resource.path, 'GET');
                displayResponse(result);
                return;
            }

            // Ações que precisam de um ID
            const form = button.closest('form');
            if (!form) return;

            const idInput = form.querySelector('input[type="text"]');
            const id = idInput ? idInput.value : null;

            if (!id && ['update', 'delete'].includes(action)) {
                alert('Por favor, insira um ID no campo de busca.');
                return;
            }

            if (action === 'update') {
                const updateJson = prompt(`Insira o JSON para atualizar o(a) ${resource.name} com ID: ${id}\n\nExemplo: {"nome": "Novo Nome"}`);
                if (!updateJson) return;
                try {
                    const body = JSON.parse(updateJson);
                    const method = resourceId === 'usuarios' ? 'PATCH' : 'PUT';
                    displayRequest(method, `${resource.path}/${id}`, body);
                    const result = await apiCall(`${resource.path}/${id}`, method, body);
                    displayResponse(result);
                } catch (err) {
                    alert('JSON inválido!');
                    displayResponse({ error: 'JSON inválido fornecido.', details: err.message });
                }
            }

            if (action === 'delete') {
                if (!confirm(`Tem certeza que deseja deletar o(a) ${resource.name} com ID: ${id}?`)) return;
                displayRequest('DELETE', `${resource.path}/${id}`, null);
                const result = await apiCall(`${resource.path}/${id}`, 'DELETE');
                displayResponse(result);
            }
        } catch (err) {
            console.error("Erro no manipulador de clique:", err);
            displayResponse({ error: 'Erro no script do dashboard (click handler)!', message: err.message });
        }
    });

    crudContainer.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const form = e.target;
            const action = form.dataset.action;
            const resourceId = form.dataset.resource;
            const resource = resources[resourceId];

            if (action === 'getById') {
                const id = form.querySelector('input').value;
                if (!id) return;
                // Para atividades, a busca por ID não existe, mas o delete sim.
                // Apenas exibimos o request para o GET para fins de visualização.
                displayRequest('GET', `${resource.path}/${id}`, null);
                const result = await apiCall(`${resource.path}/${id}`, 'GET');
                displayResponse(result);
            }

            if (action === 'create') {
                const body = {};
                resource.fields.forEach(field => {
                    const input = form.elements[field.name];
                    if (input && input.value) {
                       body[field.name] = input.type === 'number' ? Number(input.value) : input.value;
                    } else if (field.type === 'checkbox-group') {
                        // Coleta valores de grupos de checkboxes
                        const checkedBoxes = form.querySelectorAll(`input[name="${field.name}"]:checked`);
                        if (checkedBoxes.length > 0) {
                            body[field.name] = Array.from(checkedBoxes).map(cb => cb.value);
                        }
                    }
                });
                displayRequest('POST', resource.path, body);
                const result = await apiCall(resource.path, 'POST', body);
                displayResponse(result);
                if (!result.error) form.reset();
            }

            if (action === 'filter') {
                const params = new URLSearchParams();
                resource.filters.forEach(filter => {
                    const select = form.elements[filter.name];
                    if (select && select.value) {
                        params.append(filter.name, select.value);
                    }
                });
                const queryString = params.toString();
                const endpoint = queryString ? `${resource.path}?${queryString}` : resource.path;
                displayRequest('GET', endpoint, null);
                const result = await apiCall(endpoint, 'GET');
                displayResponse(result);
            }
        } catch (err) {
            console.error("Erro no manipulador de submit:", err);
            displayResponse({ error: 'Erro no script do dashboard (submit handler)!', message: err.message });
        }
    });

    async function populateSelect(select) {
        const source = select.dataset.source;
        try {
            const items = await apiCall(source, 'GET');
            if (items && Array.isArray(items)) { // Mantém a primeira opção se for um filtro
                select.innerHTML = '<option value="">-- Selecione --</option>'; // Opção padrão
                select.innerHTML += items.map(item => `
                    <option value="${item.id}">${item.nome}</option>
                `).join('');
            } else {
                select.innerHTML = '<option value="">Falha ao carregar</option>';
            }
        } catch (error) {
            console.error(`Erro ao popular select de ${source}:`, error);
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }


    async function populateCheckboxGroup(container) {
        const source = container.dataset.source;
        const name = container.dataset.name;
        try {
            const items = await apiCall(source, 'GET');
            if (items && Array.isArray(items)) {
                container.innerHTML = items.map(item => `
                    <label>
                        <input type="checkbox" name="${name}" value="${item.id}">
                        ${item.nome}
                    </label>
                `).join('');
            } else {
                container.textContent = 'Falha ao carregar opções.';
            }
        } catch (error) {
            console.error(`Erro ao popular ${name}:`, error);
            container.textContent = 'Erro ao carregar.';
        }
    }

    function initializeDashboard() {
        let html = '';
        for (const key in resources) {
            html += generateCrudHtml(resources[key], key);
            // Adiciona um botão customizado para Atividades
            if (key === 'atividades') {
                html = html.replace('</form>', `
                    </form>
                    <button class="btn-get" onclick="listMyActivities()">Listar Minhas Atividades (Professor)</button>
                `);
            }
        }
        crudContainer.innerHTML = html;
    }

    function populateAllDynamicFields() {
        document.querySelectorAll('div.checkbox-group[data-source]').forEach(populateCheckboxGroup);
        document.querySelectorAll('select[data-source]').forEach(populateSelect);
    }

    async function listMyActivities() {
        displayRequest('GET', '/atividades/professor/me', null);
        const result = await apiCall('/atividades/professor/me', 'GET');
        displayResponse(result);
    }

    initializeDashboard();


</script>

</body>
</html>